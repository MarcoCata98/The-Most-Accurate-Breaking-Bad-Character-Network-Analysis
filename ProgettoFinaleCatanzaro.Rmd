---
title: "Progetto Finale Catanzaro"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r include=FALSE}

library(tidyverse)
library(tidygraph)
library(ggraph)
library(scales)
library(igraph)
library(Matrix)
library(readr)

```

# Breaking bad 

la rete di relazioni tra i vari personaggi è complessa e spesso come accade nelle serie come questa, 
il protagonista si relaziona con diversi gruppi di persone che durante la maggior parte del tempo non interagiscono tra loro, 
ma improvvisamente avvengono plot twist che cambiano tutto, che è proprio cio che scombussola l'equilibrio narrativo.

La rete è stata generata a seguito del analisi testuale di riassunti episodio per episodio , stagione per stagione,
grazie a librerie di scraping e analisi come spacy per python
questo ha permetsso di ottenere informazioni esatte su quando 



Durante l'estrazione, il modulo di scraping ha identificato anche relazioni tra Entità propriamente non persone
come la città Alburquechi o la DEA agenzia antidroga

Avrò quindi un dataset di x frasi, da ogni frase di contesto estraggo le persone coinvolte, e ne genera gli archi, se ho più 
scene con lo stesso arco avrò un peso maggiore.






```{r}

# 1. Leggi il dataset
edges_raw <- read_csv("ProgettoFinaleBreakingBad.csv")

# 2. Rinomina correttamente le prime due colonne
edges <- edges_raw %>% 
  rename(
    from = node1,
    to   = node2
  ) %>% 
  mutate(
    from = as.character(from),
    to   = as.character(to)
  )

# 3. Crea la tabella nodi
nodes <- tibble(
  name = sort(unique(c(edges$from, edges$to)))
)

# 4. Crea il grafo
graph_bb <- tbl_graph(
  nodes = nodes,
  edges = edges,
  directed = FALSE
)

graph_bb

```


```{r}
# AGGIUNGO IL TOTALE DELLE COMPARSE

# 1. Leggo il dataset degli archi
edges_raw <- read_csv("ProgettoFinaleBreakingBad.csv")

# 2. Costruisco la tabella nodi (un nome per riga)
nodes <- tibble(
  name = sort(unique(c(edges_raw$node1, edges_raw$node2)))
)

# 3. Creo il grafo di base (non diretto)
graph_bb <- tbl_graph(
  nodes  = nodes,
  edges  = edges_raw %>% 
             rename(from = node1, to = node2),
  directed = FALSE
)

# 4. Arricchisco gli archi:
#    - Nome_from, Nome_to = nomi dei nodi collegati
#    - Totale = somma di tutti i pesi delle puntate
graph_bb <- graph_bb %>%
  activate(edges) %>%
  mutate(
    Nome_from = .N()$name[from],
    Nome_to   = .N()$name[to]
  ) %>%
  mutate(
    Totale = rowSums(across(-c(from, to, Nome_from, Nome_to)))
  ) %>%
  # Ora imposto l’ordine delle colonne come richiesto:
  select(
    from, 
    to,
    Nome_from,
    Nome_to,
    Totale,
    everything()   # tutte le colonne dei pesi dopo Totale
  )%>%
  arrange(desc(Totale))


graph_bb

```

# Descrizione del grafo

Il grafo `graph_bb` rappresenta la **rete delle co-presenze** tra i personaggi della serie *Breaking Bad*.

- **Nodi (V)**: personaggi della serie (inclusi alcuni personaggi secondari e comparse rilevanti, quando hanno un ruolo non marginale nella narrazione).
- **Archi (E)**: una coppia di personaggi \((u,v)\) è collegata se i due hanno **co-partecipato ad almeno una scena** nell’intera serie.

## Pesi degli archi e dettaglio temporale

Ogni arco contiene, oltre all’informazione di esistenza del legame, anche il **numero esatto di scene** in cui la coppia co-partecipa:

- è disponibile un conteggio **per ogni episodio di ogni stagione** (es. colonne del tipo `01S1`, `02S1`, …),
- ed è presente anche un valore aggregato (`Totale`) che rappresenta la **forza complessiva** del legame lungo tutta la serie.

In questo modo, il grafo è un **grafo pesato**: il peso di un arco misura **quanto è intensa e frequente** l’interazione tra due personaggi (più scene condivise ⇒ legame più forte).  
Inoltre, avendo il dettaglio per episodio, è possibile studiare l’**evoluzione temporale** delle relazioni e osservare come cambiano i collegamenti tra i personaggi nel corso della narrazione.



```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=9, fig.align='center'}


# 1) Tengo solo gli archi con almeno una co-presenza
g_main <- graph_bb %>% 
  activate(edges) %>% 
  filter(Totale > 0) %>%
  activate(nodes) %>%
  mutate(deg = centrality_degree()) %>%
  filter(deg > 0)   # rimuove eventuali isolati

# 2) Plot stile KK (dilatato)
set.seed(123)
options(repr.plot.width = 14, repr.plot.height = 10)

ggraph(g_main, layout = "kk") +

  # Archi sottili, grigio chiaro, non colorati
  geom_edge_link(
    colour = "grey80",
    alpha  = 0.35,
    width  = 0.8
  ) +

  # Nodi semplici, neri
  geom_node_point(
    size  = 3,
    color = "black"
  ) +

  # Etichette con repel (per avere aria e distanza)
  geom_node_text(
    aes(label = name),
    repel = TRUE,
    size = 3
  ) +

  theme_graph() +
  ggtitle("Rete delle co-presenze in Breaking Bad (tutti gli archi Totale > 0)")

```


# Analisi Preliminare

```{r include=FALSE}



```

